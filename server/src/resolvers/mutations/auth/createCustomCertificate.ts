import { Extension } from "@prisma/client";
import { AuthenticationError, UserInputError } from "apollo-server-express";
import sshpk from "sshpk";
import prisma from "../../../prisma";
import { verifyAuth } from "../../../verifyauth";

export const createCustomCertificate = async (
  _: any,
  {
    subrole,
    key,
    expiry,
  }: {
    subrole: {
      username: string;
      hostId: string;
      extensions: Extension[];
      force_command?: string;
      source_address?: string;
    };
    key: string;
    expiry: number;
  },
  { user }: { user: { id?: string } }
) => {
  if (!verifyAuth(user)) {
    throw new AuthenticationError("Invalid Auth");
  }
  const host = await prisma.host.findUnique({ where: { id: subrole.hostId } });
  if (!host) {
    throw new UserInputError("Host Unknown");
  }
  const privateKey = sshpk.parsePrivateKey(host.caKey, "ssh");
  const userKey = sshpk.parseKey(key, "ssh");
  const cert = sshpk.createCertificate(
    sshpk.identityForUser(subrole.username),
    userKey,
    sshpk.identityForUser("sshca"),
    privateKey,
    {
      validFrom: new Date(Date.now() - 5000),
      validUntil: new Date(expiry),
    }
  );
  cert.signatures.openssh!.exts = [
    ...subrole.extensions.map((extension) => ({
      name: extension.replaceAll("_", "-"),
      critical: false,
      data: Buffer.from(""),
    })),
  ];
  if (subrole.force_command) {
    const extbuf = Buffer.alloc(4 + subrole.force_command.length);
    extbuf.writeInt32BE(subrole.force_command.length);
    extbuf.write(subrole.force_command, 4);
    cert.signatures.openssh!.exts.push({
      name: "force-command",
      critical: true,
      data: extbuf,
    });
  }
  if (subrole.source_address) {
    const extbuf = Buffer.alloc(4 + subrole.source_address.length);
    extbuf.writeInt32BE(subrole.source_address.length);
    extbuf.write(subrole.source_address, 4);
    cert.signatures.openssh!.exts.push({
      name: "source-address",
      critical: true,
      data: extbuf,
    });
  }
  cert.signatures.openssh!.keyId = `SSHCA custom certifcate\nGenerated by:${
    user.id
  }\nHost:${subrole.hostId}\nGenerated at:${Date.now()}`;
  // @ts-expect-error
  const signer = privateKey.createSign("sha512");
  // @ts-expect-error
  const blob = sshpk.Certificate.formats.openssh.toBuffer(cert, true);
  signer.write(blob);
  cert.signatures.openssh!.signature = signer.sign();
  return cert.toString("openssh");
};
